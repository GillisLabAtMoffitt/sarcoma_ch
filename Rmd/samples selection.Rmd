---
title: "Sarcoma cancer and CH in Avatar data"
author: "Christelle Colin-Leitzinger"
date: '`r Sys.Date()`'
output: 
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: false
    theme: united
    highlight: pygments
    df_print: kable
editor_options: 
  chunk_output_type: console
---

<style type="text/css">

.figure {
    margin-top: 100px;
    margin-bottom: 100px;
}

table {
    margin-top: 10px;
    margin-bottom: 25px !important;
}

th, td { padding: 5px; }

</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      cache = FALSE,
                      # fig.width = 7, fig.height = 5, 
                      fig.align='center'#, fig.show='hold'
                      )
options(gtsummary.print_engine = "gt")
options(gtsummary.as_gt.addl_cmds = "gt::tab_options(table.font.size = 14, data_row.padding = gt::px(1))")
```

```{r library}
library(tidyverse)
library(data.table)
library(VennDiagram)
library(lubridate)
library(gtsummary)
library(viridis)
library(ggforce)
library(kableExtra)
```

```{r}
sarcoma_patients <- 
  read_rds("/Users/colinccm/Documents/GitHub/Gillis/sarcoma_ch/sarcoma_patients limited blood samples type.rds")

treatment <- 
  read_rds("/Users/colinccm/Documents/GitHub/Gillis/sarcoma_ch/treatment_long.rds") %>% 
  filter(treatment_type == "chemo")

Global_data <- 
  inner_join(sarcoma_patients %>% 
               distinct(mrn, specimen_collection_date, sample_type), 
             treatment, by = "mrn") %>% 
  # Create deidentified IDs
  mutate(rad = "sarcoma_study_") %>%
  group_by(mrn) %>% 
  mutate(id = cur_group_id()) %>%
  ungroup() %>%
  mutate(zero = 6 - nchar(id)) %>%
  mutate(ii = stringi::stri_dup("0", zero)) %>%
  select(c(rad, ii, id, mrn, everything())) %>%
  unite(deidentified_patient_id, rad:id, sep = "") %>% 
  select(c(deidentified_patient_id, mrn, everything(), -zero))

blood_patients <- Global_data %>% 
  # filter to patients who have blood samples
  filter(!is.na(specimen_collection_date))

write_rds(blood_patients, "blood_patients_long.rds")
```


```{r}
topo_drugs <- "epirubicin|etoposide|doxorubicin|daunorubicin|teniposide|mitoxantrone|amsacrine|actinomycin"
alk_drugs <- "melphalan|cyclophosphamide|nitrogen mustard|chlorambucil|busulfan|carboplatin|cisplatin|dacarbazine|procarbazine|carmustine|mitomycin|thiotepa|lomustine"
```


```{r}
blood_patients <- blood_patients %>%
  group_by(mrn) %>% 
  # mutate(first_chemo_date = first(treatment_start_date)) %>% 
  # mutate(last_chemo_date = last(treatment_start_date)) %>% 

  # mutate(blood_bf_chemo = case_when(
  #   specimen_collection_date <= first_chemo_date                         ~ "Yes"
  # )) %>%
  # mutate(blood_af_chemo = case_when(
  #   specimen_collection_date > last_chemo_date                           ~ "Yes"
  # )) %>%
  
  # Topoisomerase II
  mutate(blood_bf_topoII = case_when(
    specimen_collection_date <= treatment_start_date &
      str_detect(treatment, topo_drugs)                                  ~ "Yes"
  )) %>%
  mutate(have_good_presample_topo = blood_bf_topoII,
         presample_date_topo = case_when(
           blood_bf_topoII == "Yes"                                      ~ specimen_collection_date
         )) %>% 
  mutate(days_from_presample_to_topo = case_when(
    blood_bf_topoII == "Yes"                                             ~ interval(
      start = specimen_collection_date, end = treatment_start_date) /
      duration(n= 1, units = "days")
  )) %>% 
  fill(have_good_presample_topo, presample_date_topo,
       days_from_presample_to_topo,
       .direction = "updown") %>%
  ungroup() %>% 
  mutate(blood_af_topoII = case_when(
    (specimen_collection_date > presample_date_topo |
       is.na(presample_date_topo)) &
      specimen_collection_date > treatment_start_date &
      str_detect(treatment, topo_drugs)                                  ~ "Yes"
  )) %>%
  mutate(blood_during_topoII = case_when(
    specimen_collection_date > treatment_start_date &
      specimen_collection_date < treatment_end_date &
      str_detect(treatment, topo_drugs)                                  ~ "Yes"
  )) %>%
  select(mrn, deidentified_patient_id, specimen_collection_date, 
         blood_bf_topoII, blood_af_topoII, blood_during_topoII, treatment, everything()) %>% 
  
  # Alkylant agents
  mutate(blood_bf_alk = case_when(
    specimen_collection_date <= treatment_start_date &
      str_detect(treatment, alk_drugs)                                  ~ "Yes"
  )) %>%
  mutate(have_good_presample_alk = blood_bf_alk,
         presample_date_alk = case_when(
           blood_bf_alk == "Yes"                                        ~ specimen_collection_date
         )) %>% 
  mutate(days_from_presample_to_alk = case_when(
    blood_bf_alk == "Yes"                                               ~ interval(
      start = specimen_collection_date, end = treatment_start_date) /
      duration(n= 1, units = "days")
  )) %>% 
  group_by(mrn) %>% 
  fill(have_good_presample_alk, presample_date_alk,
       days_from_presample_to_alk,
       .direction = "updown") %>%
  ungroup() %>%
  mutate(blood_af_alk = case_when(
    specimen_collection_date > presample_date_alk &
    specimen_collection_date > treatment_start_date &
    specimen_collection_date > treatment_end_date &
      str_detect(treatment, alk_drugs)                                  ~ "Yes"
  )) %>%
  
  mutate(days_from_presample_to_drugs = case_when(
    blood_bf_topoII == "Yes" |
      blood_bf_alk == "Yes"                                             ~ interval(
      start = specimen_collection_date, end = treatment_start_date) /
      duration(n= 1, units = "days")
  )) %>% 
  mutate(days_from_drugs_to_after_sample = case_when(
    blood_af_topoII == "Yes" |
      blood_during_topoII == "Yes" |
      blood_af_alk == "Yes"                                             ~ interval(
      start = treatment_start_date, end = specimen_collection_date) /
      duration(n= 1, units = "days")
  )) %>% 
  
  # fill(blood_bf_topoII, 
  #      # blood_af_chemo,
  #      # blood_af_topoII,
  #      blood_bf_alk, 
  #      # blood_af_alk,
  #      # days_from_presample_to_drugs, days_from_drugs_to_after_sample,
  #      .direction = "updown") %>%

  arrange(mrn, deidentified_patient_id, specimen_collection_date)
```

<!-- # Treatment received by Sarcoma patients -->
<!-- ```{r} -->
<!-- treatment %>%  -->
<!--   filter(treatment_type != "radioT") %>%  -->
<!--   ungroup() %>%  -->
<!--   select(treatment) %>%  -->
<!--   tbl_summary() -->
<!-- ``` -->
<!-- <br> -->
<!-- <br> -->

<!-- # Patients treated with ANY drugs (53 patients) -->

<!-- ```{r} -->
<!-- blood_patients %>%  -->
<!--   filter(blood_bf_chemo == "Yes" & blood_af_chemo == "Yes") %>%  -->
<!--   distinct(deidentified_patient_id, .keep_all = TRUE) %>% -->
<!--   select(deidentified_patient_id) %>% -->
<!--   purrr::keep(~!all(is.na(.))) -->
<!-- ``` -->


# Patients with samples after or during treated with Topoisomerase II inhibitors (22 patients)

Topoisomerase II inhibitors include etoposide, doxorubicin, daunorubicin, teniposide, epirubicin, mitoxantrone, amsacrine, actinomycin.
```{r}
samples_topo <- blood_patients %>% 
  filter(blood_af_topoII == "Yes" | blood_during_topoII == "Yes") %>%
  select(mrn, deidentified_patient_id, sample_type, blood_bf_topoII, blood_during_topoII, 
         blood_af_topoII, days_from_drugs_to_after_sample, treatment, treatment_start_date, treatment_end_date) %>% 
  # pivot_wider(id_cols = c(deidentified_patient_id),
  #             names_from = treatment_line, 
  #             values_from = treatment) %>% 
  group_by(mrn, deidentified_patient_id, sample_type, blood_bf_topoII, blood_af_topoII,
           blood_during_topoII, days_from_drugs_to_after_sample, treatment_start_date) %>% 
  summarise_at(vars(treatment, treatment_end_date), str_c, collapse = "!") %>% 
  ungroup() %>% 
  separate(treatment, paste("regimen", 1:2, sep = "_"), 
           sep = "!", remove = TRUE, 
           extra = "warn", fill = "right")

write_csv(samples_topo, "list of samples topo.csv")
```

<!-- # Patients with samples during treated with Topoisomerase II inhibitors (13 patients) -->
<!-- ```{r} -->
<!-- blood_patients %>%  -->
<!--   filter(blood_during_topoII == "Yes") %>%  -->
<!--   select(deidentified_patient_id, mrn,  treatment_line, treatment) %>%  -->
<!--   group_by(deidentified_patient_id) %>%  -->
<!--   summarise_at(vars(treatment), str_c, collapse = "!") %>%  -->
<!--   ungroup() %>%  -->
<!--   separate(treatment, paste("regimen", 1:10, sep = "_"),  -->
<!--            sep = "!", remove = TRUE,  -->
<!--            extra = "warn", fill = "right") %>% -->
<!--   purrr::keep(~!all(is.na(.))) -->
<!-- ``` -->
<!-- <br> -->
<!-- <br> -->

# Patients treated with Alkylating agents (64 patients)

Alkylating agents include melphalan, cyclophosphamide, nitrogen mustard, chlorambucil, busulfan, carboplatin, cisplatin, dacarbazine, procarbazine, carmustine, mitomycin, thiotepa, lomustine.
```{r}
samples_alk <- blood_patients %>%
  filter(have_good_presample_alk == "Yes" & blood_af_alk == "Yes") %>%

  
  
  select(mrn, deidentified_patient_id, sample_type, have_good_presample_alk, blood_af_alk, 
         days_from_presample_to_alk, days_from_drugs_to_after_sample, treatment, treatment_start_date, treatment_end_date) %>% 
  group_by(mrn, deidentified_patient_id, sample_type, have_good_presample_alk, blood_af_alk,
           days_from_presample_to_alk, days_from_drugs_to_after_sample, treatment_start_date) %>% 
  summarise_at(vars(treatment, treatment_end_date), str_c, collapse = "!") %>% 
  ungroup() %>% 
  separate(treatment, paste("regimen", 1:2, sep = "_"), 
           sep = "!", remove = TRUE, 
           extra = "warn", fill = "right")

write_csv(samples_alk, "list of samples alkylant.csv")
```
