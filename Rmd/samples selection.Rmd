---
title: "Sarcoma cancer and CH in Avatar data"
author: "Christelle Colin-Leitzinger"
date: '`r Sys.Date()`'
output: 
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: false
    theme: united
    highlight: pygments
    df_print: kable
editor_options: 
  chunk_output_type: console
---

<style type="text/css">

.figure {
    margin-top: 100px;
    margin-bottom: 100px;
}

table {
    margin-top: 10px;
    margin-bottom: 25px !important;
}

th, td { padding: 5px; }

</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      cache = FALSE,
                      # fig.width = 7, fig.height = 5, 
                      fig.align='center'#, fig.show='hold'
                      )
options(gtsummary.print_engine = "gt")
options(gtsummary.as_gt.addl_cmds = "gt::tab_options(table.font.size = 14, data_row.padding = gt::px(1))")
```

```{r library}
library(tidyverse)
library(data.table)
library(VennDiagram)
library(lubridate)
library(gtsummary)
library(viridis)
library(ggforce)
library(kableExtra)
```

```{r}
sarcoma_patients <- 
  read_rds("/Users/colinccm/Documents/GitHub/Gillis/sarcoma_ch/sarcoma_patients.rds")

treatment <- 
  read_rds("/Users/colinccm/Documents/GitHub/Gillis/sarcoma_ch/treatment_long.rds") %>% 
  filter(treatment_type == "chemo")

Global_data <- 
  inner_join(sarcoma_patients, treatment, by = "mrn") %>% 
  # Create deidentified IDs
  mutate(rad = "sarcoma_study_") %>%
  group_by(mrn) %>% 
  mutate(id = cur_group_id()) %>%
  ungroup() %>%
  mutate(zero = 6 - nchar(id)) %>%
  mutate(ii = stringi::stri_dup("0", zero)) %>%
  select(c(rad, ii, id, mrn, everything())) %>%
  unite(deidentified_patient_id, rad:id, sep = "") %>% 
  select(c(deidentified_patient_id, mrn, everything(), -zero))

blood_patients <- Global_data %>% 
  # filter to patients who have blood samples
  filter(!is.na(specimen_collection_date))

write_rds(blood_patients, "blood_patients_long.rds")
```


```{r}
topo_drugs <- "epirubicin|etoposide|doxorubicin|daunorubicin|teniposide|mitoxantrone|amsacrine|actinomycin"
alk_drugs <- "melphalan|cyclophosphamide|nitrogen mustard|chlorambucil|busulfan|carboplatin|cisplatin|dacarbazine|procarbazine|carmustine|mitomycin|thiotepa|lomustine"
```


```{r}
blood_patients <- blood_patients %>%
  group_by(mrn) %>% 
  mutate(first_chemo_date = first(treatment_start_date)) %>% 
  mutate(last_chemo_date = last(treatment_start_date)) %>% 
  
  mutate(blood_bf_chemo = case_when(
    specimen_collection_date <= first_chemo_date                         ~ "Yes"
  )) %>%
  mutate(blood_af_chemo = case_when(
    specimen_collection_date > last_chemo_date                           ~ "Yes"
  )) %>%
  
  mutate(blood_bf_topoII = case_when(
    specimen_collection_date <= treatment_start_date &
      str_detect(treatment, topo_drugs)                                  ~ "Yes"
  )) %>%
  mutate(blood_af_topoII = case_when(
    specimen_collection_date > treatment_start_date &
      str_detect(treatment, topo_drugs)                                  ~ "Yes"
  )) %>%
  mutate(blood_during_topoII = case_when(
    specimen_collection_date > treatment_start_date &
      specimen_collection_date > treatment_end_date &
      str_detect(treatment, topo_drugs)                                  ~ "Yes"
  )) %>%
  
  mutate(blood_bf_alk = case_when(
    specimen_collection_date <= treatment_start_date &
      str_detect(treatment, alk_drugs)                                  ~ "Yes"
  )) %>%
  mutate(blood_af_alk = case_when(
    specimen_collection_date > treatment_start_date &
      str_detect(treatment, alk_drugs)                                  ~ "Yes"
  )) %>%
  fill(blood_bf_chemo, blood_af_chemo, 
       blood_bf_topoII, blood_af_topoII,
       blood_bf_alk, blood_af_alk,
       .direction = "updown") %>% 
  ungroup() %>% 

  arrange(mrn, deidentified_patient_id, specimen_collection_date) %>%
  select(mrn, deidentified_patient_id, specimen_collection_date, 
         blood_bf_chemo, blood_af_chemo,
         blood_bf_topoII, blood_af_topoII,
         blood_during_topoII,
         blood_bf_alk, blood_af_alk,
         treatment_start_date, treatment, 
         first_chemo_date, last_chemo_date,
         everything())
```

# Treatment received by Sarcoma patients
```{r}
treatment %>% 
  filter(treatment_type != "radioT") %>% 
  ungroup() %>% 
  select(treatment) %>% 
  tbl_summary()
```
<br>
<br>

<!-- # Patients treated with ANY drugs (53 patients) -->

<!-- ```{r} -->
<!-- blood_patients %>%  -->
<!--   filter(blood_bf_chemo == "Yes" & blood_af_chemo == "Yes") %>%  -->
<!--   distinct(deidentified_patient_id, .keep_all = TRUE) %>% -->
<!--   select(deidentified_patient_id) %>% -->
<!--   purrr::keep(~!all(is.na(.))) -->
<!-- ``` -->


# Patients with samples after or during treated with Topoisomerase II inhibitors (22 patients)

Topoisomerase II inhibitors include etoposide, doxorubicin, daunorubicin, teniposide, epirubicin, mitoxantrone, amsacrine, actinomycin.
```{r}
blood_patients %>% 
  filter(blood_af_topoII == "Yes") %>% 
  select(deidentified_patient_id, treatment_line, treatment) %>% 
  # pivot_wider(id_cols = c(deidentified_patient_id),
  #             names_from = treatment_line, 
  #             values_from = treatment) %>% 
  group_by(deidentified_patient_id) %>% 
  summarise_at(vars(treatment), str_c, collapse = "!") %>% 
  ungroup() %>% 
  separate(treatment, paste("regimen", 1:10, sep = "_"), 
           sep = "!", remove = TRUE, 
           extra = "warn", fill = "right") %>%
  purrr::keep(~!all(is.na(.)))
```

# Patients with samples during treated with Topoisomerase II inhibitors (13 patients)
```{r}
blood_patients %>% 
  filter(blood_during_topoII == "Yes") %>% 
  select(deidentified_patient_id, treatment_line, treatment) %>% 
  group_by(deidentified_patient_id) %>% 
  summarise_at(vars(treatment), str_c, collapse = "!") %>% 
  ungroup() %>% 
  separate(treatment, paste("regimen", 1:10, sep = "_"), 
           sep = "!", remove = TRUE, 
           extra = "warn", fill = "right") %>%
  purrr::keep(~!all(is.na(.)))
```
<br>
<br>

<!-- # Patients treated with Alkylating agents (64 patients) -->

<!-- Alkylating agents include melphalan, cyclophosphamide, nitrogen mustard, chlorambucil, busulfan, carboplatin, cisplatin, dacarbazine, procarbazine, carmustine, mitomycin, thiotepa, lomustine. -->
<!-- ```{r} -->
<!-- blood_patients %>%  -->
<!--   filter(blood_bf_alk == "Yes" & blood_af_alk == "Yes") %>%  -->
<!--   distinct(deidentified_patient_id, .keep_all = TRUE) %>% -->
<!--   select(deidentified_patient_id) %>% -->
<!--   purrr::keep(~!all(is.na(.))) -->
<!-- ``` -->
